---
title: "Computational Finance Assignment II"
author: "Lucas Johan Boesen"
date: Sys.Date()
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Libraries
```{r}
library(dplyr)
library(matlib)
source(paste0(getwd(), "/helper_functions_sim.R"))
```
# S.1
## S.1 - Figure 2
```{r, fig.width = 3, fig.height = 3}
set.seed(3)

K <- 1
d <- 1
Tt <- 1
sigma <- 0.2
num_ite <- 10000
call_prices <- c(rep(0, num_ite))
rand_norm_0 <- rnorm(num_ite)
rand_norm_T <- rnorm(num_ite)

# Simulated call prices
S_0 <- K + d * sigma * sqrt(Tt) * rand_norm_0
S_0 <- S_0 %>% as_tibble() %>% arrange(value) %>% pull()
S_T <- S_0 + sigma * sqrt(Tt) * rand_norm_T

call_prices <- sapply(S_T, FUN = function(x)max(x - K, 0))

# LM
call_simulations <- cbind(S_0, call_prices) %>% 
  as_data_frame()
est_pricing_func <- lm(call_prices ~ poly(S_0, 7, raw=TRUE), data = call_simulations)

# True pricing function
true_pricing_function <- function(S0, Tt, K, sigma){
  d <- (S0-K)/(sigma*Tt)
  return((S0-K)*pnorm(d)+sigma*sqrt(Tt)*dnorm(d))
}

true_prices <- true_pricing_function(S_0, Tt, K, sigma)
S_0_to_plot <- S_0 

plot(x = S_0, y = call_prices, 
       col = 'grey',
       ylab = "Call value",
       xlab = "Stock price") + 
    lines(S_0_to_plot, 
          est_pricing_func$fitted.values, col = 'red', type = 'l') + 
    lines(S_0_to_plot, 
          true_prices, 
          type = 'l')

derr_pricing_func_val <- est_derr_pricing_function(est_pricing_func$coefficients[-1],
                                                    S_0_to_plot)
# actual derrivatives
true_derr <- pnorm((S_0-K)/(sigma * sqrt(Tt)))

plot(S_0_to_plot, 
  derr_pricing_func_val, 
  type = 'l',
  col = 'red',
  ylab = "Call Delta",
  xlab = "Stock price", add = TRUE) + 
  lines(S_0_to_plot,
        true_derr)
```

## S.1 - Figure 3
```{r, fig.width = 3, fig.height = 3}
plot_index <- S_0_to_plot %>% as_tibble() %>% filter(value < 0.5)

f_w_05 <- calculate_delta(S_0, sigma, 1, 0.5)

f_w_0 <- calculate_delta(S_0, sigma, 1, 1e-12)


remove_from_plot <- -c(seq(dim(plot_index)[1]))
plot(y = f_w_05$D, 
        x = S_0_to_plot, col = "grey", type = "p",
     xlim = c(0.2, 1.7), ylim = c(-0.1, 1.3), 
     xlab=("Stock price"), ylab=("Call Delta"), title = ("Est"))
text(4, 9, "True Delta")+ 
  lines(S_0_to_plot[remove_from_plot],
       true_derr[remove_from_plot], col = "black")+ 
  lines(y = f_w_05$delta[remove_from_plot], 
        x = S_0_to_plot[remove_from_plot], type = 'l', col = "red") +
  lines(S_0_to_plot[remove_from_plot], 
  derr_pricing_func_val[remove_from_plot], col = "blue") + 
  lines(y = f_w_0$delta[remove_from_plot], 
        x = S_0_to_plot[remove_from_plot], col = "orange")
text(0.22, 0.8, "Black: True Delta", col = "black", cex = .65, adj = 0)
text(0.22, 0.7, "Blue: Price only-regression", col = "blue", cex = .65, adj = 0)
text(0.22, 0.6, "Red: Half/half-regression", col = "red", cex = .65, adj = 0)
text(0.22, 0.5, "Orange: Delta only-regression", col = "orange", cex = .65, adj = 0)
text(0.22, 1.2, "Grey o's: Simulated Deltas", col = "grey", cex = .65, adj = 0)
```

## S.1 - Figure 4
```{r, warning = FALSE, message = FALSE}
seed <- 42
K <- 1; Tt <- 1; sigma <- 0.2; dt <- 1/52; num_rep <- 1000; w <- 0.5;batch_size <- 10; d <- 1
simulations <- c(400, 600, 1000, 2000, 3000, 4000, 5000, 6000)
true_delta_err <- w_05_delta_err_7 <- matrix(c(rep(0, length(simulations)*batch_size)), ncol = length(simulations))
pricing_delta_err_3 <- w_05_delta_err_3 <- w_05_delta_err_7
pricing_delta_err_4 <- w_05_delta_err_4 <- w_05_delta_err_7
pricing_delta_err_5 <- w_05_delta_err_5 <- w_05_delta_err_7
pricing_delta_err_6 <- w_05_delta_err_6 <- w_05_delta_err_7
pricing_delta_err_7 <- w_05_delta_err_7 <- w_05_delta_err_7
pricing_delta_err_8 <- w_05_delta_err_8 <- w_05_delta_err_7
pricing_delta_err_9 <- w_05_delta_err_9 <- w_05_delta_err_7
initial_price <- ZeroRateBachelierCall(1, Tt, K, sigma)$Price
for(j in 1:batch_size){
  for(i in 1:length(simulations)){
    set.seed(j)
    num_sim <- simulations[i]
    St <- c(rep(1, num_rep))
    rand_norm_0 <- rnorm(num_sim)
    S_0 <- K + d * sigma * sqrt(Tt) * rand_norm_0

    ### Calculating true delta hedge error
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, true_delta, pol_degree = 7, seed = seed)
    true_delta_err[j, i] <- err / initial_price
    
    ### Calculating using w = 0.5 
    coefs <- NULL
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 delta_func = calculate_delta, pol_degree = 3, w = 0.5, seed = seed, coefs = coefs)
    w_05_delta_err_3[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 4, w = 0.5, seed = seed, coefs = coefs)
    w_05_delta_err_4[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 5, w = 0.5, seed = seed, coefs = coefs)
    w_05_delta_err_5[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 6, w = 0.5, seed = seed, coefs = coefs)
    w_05_delta_err_6[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 7, w = 0.5, seed = seed, coefs = coefs)
    w_05_delta_err_7[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 8, w = 0.5, seed = seed, coefs = coefs)
    w_05_delta_err_8[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 9, w = 0.5, seed = seed, coefs = coefs)
    w_05_delta_err_9[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, calculate_delta_price, pol_degree = 3, seed = seed)
    pricing_delta_err_3[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, calculate_delta_price, pol_degree = 4, seed = seed)
    pricing_delta_err_4[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, calculate_delta_price, pol_degree = 5, seed = seed)
    pricing_delta_err_5[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, calculate_delta_price, pol_degree = 6, seed = seed)
    pricing_delta_err_6[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, calculate_delta_price, pol_degree = 7, seed = seed)
    pricing_delta_err_7[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, calculate_delta_price, pol_degree = 8, seed = seed)
    pricing_delta_err_8[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, calculate_delta_price, pol_degree = 9, seed = seed)
    pricing_delta_err_9[j, i] <- err / initial_price
    
  }
}
```

## S.1 - Figure 4 plot
```{r}
true_delta_err <- colMeans(true_delta_err)
w_05_delta_err_3 <- colMeans(w_05_delta_err_3)
pricing_delta_err_3 <- colMeans(pricing_delta_err_3)
w_05_delta_err_4 <- colMeans(w_05_delta_err_4)
pricing_delta_err_4 <- colMeans(pricing_delta_err_4)
w_05_delta_err_5 <- colMeans(w_05_delta_err_5)
pricing_delta_err_5 <- colMeans(pricing_delta_err_5)
w_05_delta_err_6 <- colMeans(w_05_delta_err_6)
pricing_delta_err_6 <- colMeans(pricing_delta_err_6)
w_05_delta_err_7 <- colMeans(w_05_delta_err_7)
pricing_delta_err_7 <- colMeans(pricing_delta_err_7)
w_05_delta_err_8 <- colMeans(w_05_delta_err_8)
pricing_delta_err_8 <- colMeans(pricing_delta_err_8)
w_05_delta_err_9 <- colMeans(w_05_delta_err_9)
pricing_delta_err_9 <- colMeans(pricing_delta_err_9)

plot(y = true_delta_err, simulations, type = 'l', lty = 2, ylim = c(0.09, 0.4), col = "red") +
  lines(y = pricing_delta_err_3, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_4, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_5, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_6, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_7, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_8, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_9, x = simulations, type = 'b', col = "orange")+
  lines(y = w_05_delta_err_3, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_4, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_5, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_6, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_7, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_8, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_9, x = simulations, type = 'b', col = "blue")
text(200, true_delta_err[1]+0.02, paste0("Heding with true Delta"), col = "red", cex = .65, adj = 0)
text(6100, pricing_delta_err_3[8], paste0("3"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_4[8], paste0("4"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_5[8], paste0("5"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_6[8], paste0("6"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_7[8], paste0("7"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_8[8], paste0("8"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_9[8], paste0("9"), col = "orange", cex = .65, adj = 0)
text(6100, w_05_delta_err_3[8], paste0("3"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_4[8], paste0("4"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_5[8], paste0("5"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_6[8], paste0("6"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_7[8], paste0("7"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_8[8], paste0("8"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_9[8], paste0("9"), col = "blue", cex = .65, adj = 0)
```

# S.2
## S.2 - Figure 2
```{r, fig.width = 3, fig.height = 3}
set.seed(1)

K <- 1
d <- 1
Tt <- 1
sigma <- 0.2
num_ite <- 10000
call_prices <- c(rep(0, num_ite))
rand_norm_0 <- rnorm(num_ite)
rand_norm_T <- rnorm(num_ite)

# Simulated call prices
S_0 <- K * exp(-1/2 * sigma^2 * Tt + sigma * sqrt(Tt) * rand_norm_T)
S_0 <- S_0 %>% as_tibble() %>% arrange(value) %>% pull()
S_T <- S_0 * exp(-1/2 * sigma^2 * Tt + sigma * sqrt(Tt) * rand_norm_T)

call_prices <- sapply(S_T, FUN = function(x)max(x - K, 0))

# LM
call_simulations <- cbind(S_0, call_prices) %>% 
  as_data_frame()
est_pricing_func <- lm(call_prices ~ poly(S_0, 7, raw=TRUE), data = call_simulations)

# True pricing function
true_prices <- BS_func(S_0, K, sigma, Tt)$Price
S_0_to_plot <- S_0 

plot(x = S_0, y = call_prices, 
       col = 'grey',
       ylab = "Call value",
       xlab = "Stock price") + 
    lines(S_0_to_plot, 
          est_pricing_func$fitted.values, col = 'red', type = 'l') + 
    lines(S_0_to_plot, 
          true_prices, 
          type = 'l')+ 
  title("Black Scholes")

derr_pricing_func_val <- est_derr_pricing_function(est_pricing_func$coefficients[-1],
                                                    S_0_to_plot)
# actual derrivatives
d1 <- (log(S_0 / K) + (1/2 * sigma^2) * Tt) / (sigma * Tt)
true_derr <- pnorm(d1)

plot(S_0_to_plot, 
  derr_pricing_func_val, 
  type = 'l',
  col = 'red',
  ylab = "Call Delta",
  xlab = "Stock price", add = TRUE) + 
  lines(S_0_to_plot,
        true_derr) + 
  title("Black Scholes")
```
## S.2 - Figure 3
```{r, fig.width = 3, fig.height = 3}
plot_index <- S_0_to_plot %>% as_tibble() %>% filter(value < 0.5)

f_w_05 <- calculate_delta(S_0, sigma, 1, 0.5, BS = TRUE)

f_w_0 <- calculate_delta(S_0, sigma, 1, 1e-12, BS = TRUE)

remove_from_plot <- -c(seq(dim(plot_index)[1]))
plot(y = f_w_05$D, 
        x = S_0_to_plot, col = "grey", type = "p",
     #xlim = c(0.2, 1.7), ylim = c(-0.1, 1.3), 
     xlab=("Stock price"), ylab=("Call Delta"), title = ("Est"))
text(4, 9, "True Delta")+ 
  lines(S_0_to_plot[remove_from_plot],
       true_derr[remove_from_plot], col = "black")+ 
  lines(y = f_w_05$delta[remove_from_plot], 
        x = S_0_to_plot[remove_from_plot], type = 'l', col = "red") +
  lines(S_0_to_plot[remove_from_plot], 
  derr_pricing_func_val[remove_from_plot], col = "blue") + 
  lines(y = f_w_0$delta[remove_from_plot], 
        x = S_0_to_plot[remove_from_plot], col = "orange")
text(0.22, 0.8, "Black: True Delta", col = "black", cex = .65, adj = 0)
text(0.22, 0.7, "Blue: Price only-regression", col = "blue", cex = .65, adj = 0)
text(0.22, 0.6, "Red: Half/half-regression", col = "red", cex = .65, adj = 0)
text(0.22, 0.5, "Orange: Delta only-regression", col = "orange", cex = .65, adj = 0)
text(0.22, 1.2, "Grey o's: Simulated Deltas", col = "grey", cex = .65, adj = 0)
```

## S.2 - Figure 4
```{r, warning = FALSE, message = FALSE}
seed <- 42
K <- 1; Tt <- 1; sigma <- 0.2; dt <- 1/52; num_rep <- 1000; w <- 0.5;batch_size <- 10
simulations <- c(400, 600, 1000, 2000, 3000, 4000, 5000, 6000)
true_delta_err <- w_05_delta_err_7 <- matrix(c(rep(0, length(simulations)*batch_size)), ncol = length(simulations))
pricing_delta_err_3 <- w_05_delta_err_3 <- w_05_delta_err_7
pricing_delta_err_4 <- w_05_delta_err_4 <- w_05_delta_err_7
pricing_delta_err_5 <- w_05_delta_err_5 <- w_05_delta_err_7
pricing_delta_err_6 <- w_05_delta_err_6 <- w_05_delta_err_7
pricing_delta_err_7 <- w_05_delta_err_7 <- w_05_delta_err_7
pricing_delta_err_8 <- w_05_delta_err_8 <- w_05_delta_err_7
pricing_delta_err_9 <- w_05_delta_err_9 <- w_05_delta_err_7
initial_price <- BS_func(St = 1, K = K, sigma = sigma, Tt = Tt)$Price
for(j in 1:batch_size){
  for(i in 1:length(simulations)){
    set.seed(j)
    #seed <- j
    num_sim <- simulations[i]
    St <- c(rep(1, num_rep))
    rand_norm_0 <- rnorm(num_sim)
    S_0 <- K * exp(-1/2 * sigma^2 * Tt + sigma * sqrt(Tt) * rand_norm_0)
    S_0 <- S_0 %>% as_tibble() %>% arrange(value) %>% pull()

    ### Calculating true delta hedge error
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 true_delta, pol_degree = 7, seed = seed, BS = TRUE, call_func = BS_func)
    true_delta_err[j, i] <- err / initial_price
    
    ### Calculating using w = 0.5 
    coefs <- NULL
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 3, w = 0.5, seed = seed, coefs = coefs, BS = TRUE, call_func = BS_func)
    w_05_delta_err_3[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 4, w = 0.5, seed = seed, coefs = coefs, BS = TRUE, call_func = BS_func)
    w_05_delta_err_4[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 5, w = 0.5, seed = seed, coefs = coefs, BS = TRUE, call_func = BS_func)
    w_05_delta_err_5[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 6, w = 0.5, seed = seed, coefs = coefs, BS = TRUE, call_func = BS_func)
    w_05_delta_err_6[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 7, w = 0.5, seed = seed, coefs = coefs, BS = TRUE, call_func = BS_func)
    w_05_delta_err_7[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 8, w = 0.5, seed = seed, coefs = coefs, BS = TRUE, call_func = BS_func)
    w_05_delta_err_8[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 9, w = 0.5, seed = seed, coefs = coefs, BS = TRUE, call_func = BS_func)
    w_05_delta_err_9[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta_price, pol_degree = 3, seed = seed, BS = TRUE, call_func = BS_func)
    pricing_delta_err_3[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta_price, pol_degree = 4, seed = seed, BS = TRUE, call_func = BS_func)
    pricing_delta_err_4[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta_price, pol_degree = 5, seed = seed, BS = TRUE, call_func = BS_func)
    pricing_delta_err_5[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta_price, pol_degree = 6, seed = seed, BS = TRUE, call_func = BS_func)
    pricing_delta_err_6[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta_price, pol_degree = 7, seed = seed, BS = TRUE, call_func = BS_func)
    pricing_delta_err_7[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta_price, pol_degree = 8, seed = seed, BS = TRUE, call_func = BS_func)
    pricing_delta_err_8[j, i] <- err / initial_price
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta_price, pol_degree = 9, seed = seed, BS = TRUE, call_func = BS_func)
    pricing_delta_err_9[j, i] <- err / initial_price
    
  }
}
```

## S.2 - Figure 4 plot
```{r}
true_delta_err_mean <- colMeans(true_delta_err)
w_05_delta_err_3_mean <- colMeans(w_05_delta_err_3)
pricing_delta_err_3_mean <- colMeans(pricing_delta_err_3)
w_05_delta_err_4_mean <- colMeans(w_05_delta_err_4)
pricing_delta_err_4_mean <- colMeans(pricing_delta_err_4)
w_05_delta_err_5_mean <- colMeans(w_05_delta_err_5)
pricing_delta_err_5_mean <- colMeans(pricing_delta_err_5)
w_05_delta_err_6_mean <- colMeans(w_05_delta_err_6)
pricing_delta_err_6_mean <- colMeans(pricing_delta_err_6)
w_05_delta_err_7_mean <- colMeans(w_05_delta_err_7)
pricing_delta_err_7_mean <- colMeans(pricing_delta_err_7)
w_05_delta_err_8_mean <- colMeans(w_05_delta_err_8)
pricing_delta_err_8_mean <- colMeans(pricing_delta_err_8)
w_05_delta_err_9_mean <- colMeans(w_05_delta_err_9)
pricing_delta_err_9_mean <- colMeans(pricing_delta_err_9)

plot(y = true_delta_err_mean, simulations, type = 'l', lty = 2, ylim = c(0.09, 1), col = "red") +
  lines(y = pricing_delta_err_3_mean, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_4_mean, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_5_mean, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_6_mean, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_7_mean, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_8_mean, x = simulations, type = 'b', col = "orange")+
  lines(y = pricing_delta_err_9_mean, x = simulations, type = 'b', col = "orange")+
  lines(y = w_05_delta_err_3_mean, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_4_mean, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_5_mean, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_6_mean, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_7_mean, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_8_mean, x = simulations, type = 'b', col = "blue")+
  lines(y = w_05_delta_err_9_mean, x = simulations, type = 'b', col = "blue")
text(200, true_delta_err_mean[1]+0.02, paste0("Heding with true Delta"), col = "red", cex = .65, adj = 0)
text(6100, pricing_delta_err_3_mean[8], paste0("3"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_4_mean[8], paste0("4"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_5_mean[8], paste0("5"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_6_mean[8], paste0("6"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_7_mean[8], paste0("7"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_8_mean[8], paste0("8"), col = "orange", cex = .65, adj = 0)
text(6100, pricing_delta_err_9_mean[8], paste0("9"), col = "orange", cex = .65, adj = 0)
text(6100, w_05_delta_err_3_mean[8], paste0("3"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_4_mean[8], paste0("4"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_5_mean[8], paste0("5"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_6_mean[8], paste0("6"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_7_mean[8], paste0("7"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_8_mean[8], paste0("8"), col = "blue", cex = .65, adj = 0)
text(6100, w_05_delta_err_9_mean[8], paste0("9"), col = "blue", cex = .65, adj = 0)
```

# S.3 - Figure 4
## S.3 - Figure 4
```{r, warning = FALSE, message = FALSE}
seed <- 42
K <- 1; Tt <- 1; sigma <- 0.2; dt <- 1/52; num_rep <- 1000; w <- 0.5;batch_size <- 10
simulations <- c(400, 600, 1000, 2000, 3000, 4000, 5000, 6000)
lrm_3 <- lrm_8 <- std_3 <- std_8 <- matrix(c(rep(0, length(simulations)*batch_size)), ncol = length(simulations))
initial_price <- BS_func(1, K, sigma, Tt)$Price
for(j in 1:batch_size){
  for(i in 1:length(simulations)){
    set.seed(j)
    # seed <- j+11
    #seed <- j
    num_sim <- simulations[i]
    St <- c(rep(1, num_rep))
    rand_norm_0 <- rnorm(num_sim)
    S_0 <- K * exp(-1/2 * sigma^2 * Tt + sigma * sqrt(Tt) * rand_norm_0)
    S_0 <- S_0 %>% as_tibble() %>% arrange(value) %>% pull()

    ### Calculating using w = 0.5 
    coefs <- NULL
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 3, w = 0.5, seed = seed, coefs = coefs, 
                                 BS = TRUE, call_func = BS_func, LRM = TRUE)
    lrm_3[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 8, w = 0.5, seed = seed, coefs = coefs, 
                                 BS = TRUE, call_func = BS_func, LRM = TRUE)
    lrm_8[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                             calculate_delta, pol_degree = 3, w = 0.5, seed = seed, coefs = coefs, 
                             BS = TRUE, call_func = BS_func, LRM = FALSE)
    std_3[j, i] <- err / initial_price
    
    err <- calculate_hedge_error(dt, Tt, num_rep, K, sigma, St, S0 = S_0, 
                                 calculate_delta, pol_degree = 8, w = 0.5, seed = seed, coefs = coefs, 
                                 BS = TRUE, call_func = BS_func, LRM = FALSE)
    std_8[j, i] <- err / initial_price
    
  }
}
```

## S.2 - Figure 4 plot
```{r}
lrm_3_mean <- colMeans(lrm_3)
lrm_8_mean <- colMeans(lrm_8)
std_3_mean <- colMeans(std_3)
std_8_mean <- colMeans(std_8)

plot(y = lrm_3_mean, simulations, type = 'b', ylim = c(0.09, 1), xlim = c(0, 6500), col = "orange") +
  lines(y = lrm_8_mean, x = simulations, type = 'b', col = "orange")+
  lines(y = std_3_mean, x = simulations, type = 'b', col = "blue")+
  lines(y = std_8_mean, x = simulations, type = 'b', col = "blue") 
text(6100, lrm_3_mean[8], paste0("LRM 3"), col = "orange", cex = .65, adj = 0)
text(6100, lrm_8_mean[8], paste0("LRM 8"), col = "orange", cex = .65, adj = 0)
text(6100, std_3_mean[8], paste0("BS 3"), col = "blue", cex = .65, adj = 0)
text(6100, std_8_mean[8], paste0("BS 8"), col = "blue", cex = .65, adj = 0)

```